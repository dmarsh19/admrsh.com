{% extends "template.html" %}
{% block content %}
  <link href="/static/css/pygments.css" rel="stylesheet">
  <div class="content container">
    <h1 align="center">Socket Chat</h1>
    <h3>A simple, lightweight LAN Messenger.</h3>
    <p>I have several older machines in my home network that I repurpose fairly frequently. Sometimes it's to try a new OS, a new application or service, or to act as a dev/test machine so I can tinker with the correct setup. In any case, it takes some initial configuration to get a machine to a usable state. I've streamlined some of this with setup scripts, what I call setting up the <strong><a href="https://www/github.com/dmarsh19/infrastructure.git">infrastructure</a></strong>, which I keep in a repo for portability.</p>
    <p>Of course there are things that have no place in a shared location, whether they are too sensitive or don't belong in a script. VNC and RDP have their merits, bu they can be overkill for something as simple as copying a line of text. And in a home environment where files are often distributed with no real central depository, I often need access to multiple machines.Configurations, keys, machine namesI don't want to here.m often working across platforms and I needed a simple, user friendly, and reliable way to share text back and forth on machines within my home network. during setups or for testing applications across various machines.
      Not too bad for less than 400 lines of code!
    </p>
    <p>You can find the entire repo <strong><a href="https://www.github.com/dmarsh19/socket_chat.git">here</a></strong></p>

    <p>I stuck with built-in Python only so there were no required libraries to install. Additionally, I wanted to support Python2 and Python3, but I defaulted the interpreter to Python3 so the script can run by just clicking to execute.</p>
    <!-- generated by Pygments -->
    <div class="highlight"><pre>
      <div class="highlight"><pre><span></span><span class="lineno">  1 </span><span class="ch">#!/usr/bin/env python3</span>
      <span class="lineno">  2 </span><span class="sd">&quot;&quot;&quot;</span>
      <span class="lineno">  3 </span><span class="sd">-menu on ChatWindow. Add connection if not in config</span>
      <span class="lineno">  4 </span><span class="sd">-NewConnection user message if connection already exists</span>
      <span class="lineno">  5 </span><span class="sd">-load_config populate_connection map() in Python3</span>
      <span class="lineno">  6 </span><span class="sd">&quot;&quot;&quot;</span>
      <span class="lineno">  7 </span><span class="kn">import</span> <span class="nn">os</span>
      <span class="lineno">  8 </span><span class="kn">import</span> <span class="nn">time</span>
      <span class="lineno">  9 </span><span class="kn">import</span> <span class="nn">datetime</span>
      <span class="lineno"> 10 </span><span class="kn">import</span> <span class="nn">socket</span>
      <span class="lineno"> 11 </span><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
      <span class="lineno"> 12 </span><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
      <span class="lineno"> 13 </span><span class="kn">from</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">import</span> <span class="n">ElementTree</span><span class="p">,</span> <span class="n">Element</span><span class="p">,</span> <span class="n">SubElement</span><span class="p">,</span> <span class="n">parse</span><span class="p">,</span> <span class="n">iselement</span><span class="p">,</span> <span class="n">ParseError</span>
      <span class="lineno"> 14 </span><span class="k">try</span><span class="p">:</span>
      <span class="lineno"> 15 </span>    <span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
      <span class="lineno"> 16 </span>    <span class="kn">from</span> <span class="nn">socketserver</span> <span class="kn">import</span> <span class="n">ThreadingTCPServer</span><span class="p">,</span> <span class="n">BaseRequestHandler</span>
      <span class="lineno"> 17 </span>    <span class="kn">import</span> <span class="nn">tkinter</span> <span class="kn">as</span> <span class="nn">tk</span>
      <span class="lineno"> 18 </span>    <span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">ttk</span>
      <span class="lineno"> 19 </span>    <span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">filedialog</span> <span class="k">as</span> <span class="n">tkfiledialog</span>
      <span class="lineno"> 20 </span>    <span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">scrolledtext</span>
      <span class="lineno"> 21 </span><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
      <span class="lineno"> 22 </span>    <span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Queue</span>
      <span class="lineno"> 23 </span>    <span class="kn">from</span> <span class="nn">SocketServer</span> <span class="kn">import</span> <span class="n">ThreadingTCPServer</span><span class="p">,</span> <span class="n">BaseRequestHandler</span>
      <span class="lineno"> 24 </span>    <span class="kn">import</span> <span class="nn">Tkinter</span> <span class="kn">as</span> <span class="nn">tk</span>
      <span class="lineno"> 25 </span>    <span class="kn">import</span> <span class="nn">ttk</span>
      <span class="lineno"> 26 </span>    <span class="kn">import</span> <span class="nn">tkFileDialog</span> <span class="kn">as</span> <span class="nn">tkfiledialog</span>
      <span class="lineno"> 27 </span>    <span class="kn">import</span> <span class="nn">ScrolledText</span> <span class="kn">as</span> <span class="nn">scrolledtext</span>
    </pre></div>

    <p>The main application class. This is created when the user runs the script and only one is ever instantiated. This starts a new thread where a TCP server listens for incoming messages. includes a GUI window listing available connections. If needed in the future, multiple windows can be spawned in order to talk to multiple clients.</p>
    <div class="highlight"><pre>
      <span class="lineno"> 30 </span><span class="k">class</span> <span class="nc">ChatMain</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="p">):</span>
      <span class="lineno"> 31 </span>    <span class="sd">&quot;&quot;&quot;Starts the chat application, including:</span>
      <span class="lineno"> 32 </span><span class="sd">    - List of hosts that can be messaged</span>
      <span class="lineno"> 33 </span><span class="sd">    - read/write configuration</span>
      <span class="lineno"> 34 </span><span class="sd">    - server to process incoming messages&quot;&quot;&quot;</span>
      <span class="lineno"> 35 </span>    <span class="n">msg_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
      <span class="lineno"> 36 </span>    <span class="n">queue_listener_delay</span> <span class="o">=</span> <span class="mi">250</span> <span class="c1"># ms</span>
      <span class="lineno"> 37 </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file_path</span><span class="o">=</span><span class="s2">&quot;socketchat.xml&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="lineno"> 38 </span>        <span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;chatmain&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="lineno"> 39 </span>        <span class="c1"># build ui</span>
      <span class="lineno"> 40 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span> <span class="c1"># The Frame fills tk.master. Following widgets are built within Frame.</span>
      <span class="lineno"> 41 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">resizable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># not resizeable</span>
      <span class="lineno"> 42 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Socket Chat&#39;</span><span class="p">)</span>
      <span class="lineno"> 43 </span>        <span class="c1"># grab focus</span>
      <span class="lineno"> 44 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">focus_force</span><span class="p">()</span>
      <span class="lineno"> 45 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="lineno"> 46 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">filemenu</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">,</span> <span class="n">tearoff</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="lineno"> 47 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filemenu</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;File&#39;</span><span class="p">)</span>
      <span class="lineno"> 48 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Treeview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="n">selectmode</span><span class="o">=</span><span class="s1">&#39;browse&#39;</span><span class="p">)</span>
      <span class="lineno"> 49 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">ysb</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Scrollbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">yview</span><span class="p">)</span>
      <span class="lineno"> 50 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;yscroll&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ysb</span><span class="o">.</span><span class="n">set</span>
      <span class="lineno"> 51 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">)</span>
      <span class="lineno"> 52 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="lineno"> 53 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">ysb</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;ns&quot;</span><span class="p">)</span>
      <span class="lineno"> 54 </span>
      <span class="lineno"> 55 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">)</span>
      <span class="lineno"> 56 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;request_server&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>
      <span class="lineno"> 57 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;request_server&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">))</span>
      <span class="lineno"> 58 </span>
      <span class="lineno"> 59 </span>        <span class="n">request_server</span> <span class="o">=</span> <span class="n">ThreadingTCPServer</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">ChatRequestHandler</span><span class="p">)</span>
      <span class="lineno"> 60 </span>        <span class="c1"># can be called using self.server.queue from inside ChatRequestHandler</span>
      <span class="lineno"> 61 </span>        <span class="n">request_server</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_queue</span>
      <span class="lineno"> 62 </span>        <span class="n">request_server_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">request_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>
      <span class="lineno"> 63 </span>        <span class="c1"># if main thread is closed, exit all other threads</span>
      <span class="lineno"> 64 </span>        <span class="n">request_server_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="lineno"> 65 </span>        <span class="n">request_server</span><span class="o">.</span><span class="n">daemon_threads</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="lineno"> 66 </span>        <span class="n">request_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
      <span class="lineno"> 67 </span>        <span class="c1"># add menu commands after config is loaded</span>
      <span class="lineno"> 68 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">filemenu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Load Configuration&#39;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">)</span>
      <span class="lineno"> 69 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">filemenu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Add Connection&#39;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">NewConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
      <span class="lineno"> 70 </span>        <span class="c1"># start listener for messages placed on queue</span>
      <span class="lineno"> 71 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">queue_listener_ptr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_listener_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_queue</span><span class="p">)</span>
      <span class="lineno"> 72 </span>        <span class="c1"># callback for closing window</span>
      <span class="lineno"> 73 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">protocol</span><span class="p">(</span><span class="s1">&#39;WM_DELETE_WINDOW&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
      <span class="lineno"> 74 </span>    <span class="c1"># END __init__()</span>
      <span class="lineno"> 75 </span>
      <span class="lineno"> 76 </span>    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file_path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="lineno"> 77 </span>        <span class="sd">&quot;&quot;&quot;Callable function, run from the menu, in order to assist user in selecting an xml file.</span>
      <span class="lineno"> 78 </span><span class="sd">        Passes the file to perform the logic of loading/refreshing the connections.</span>
      <span class="lineno"> 79 </span><span class="sd">        -config_file_path=None: &#39;Load Configuration&#39; was called from ChatMain menu. Prompt user to</span>
      <span class="lineno"> 80 </span><span class="sd">          select file. Try to load if selected. If cancel selection, do nothing.&quot;&quot;&quot;</span>
      <span class="lineno"> 81 </span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file_path</span><span class="p">:</span>
      <span class="lineno"> 82 </span>            <span class="n">filetypes</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;All types&quot;</span><span class="p">,</span> <span class="s2">&quot;*.*&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;eXtensible Markup Language file&quot;</span><span class="p">,</span> <span class="s2">&quot;*.xml&quot;</span><span class="p">))</span>
      <span class="lineno"> 83 </span>            <span class="n">config_file_path</span> <span class="o">=</span> <span class="n">tkfiledialog</span><span class="o">.</span><span class="n">askopenfilename</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">filetypes</span><span class="o">=</span><span class="n">filetypes</span><span class="p">,</span>
      <span class="lineno"> 84 </span>                                                            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Load Configuration&#39;</span><span class="p">,</span>
      <span class="lineno"> 85 </span>                                                            <span class="n">defaultextension</span><span class="o">=</span><span class="s2">&quot;.xml&quot;</span><span class="p">,</span>
      <span class="lineno"> 86 </span>                                                            <span class="n">initialdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
      <span class="lineno"> 87 </span>        <span class="c1"># if user cancels selecting a file, config_file_path still empty.</span>
      <span class="lineno"> 88 </span>        <span class="c1"># No more logic so we don&#39;t wipe out any existing connections.</span>
      <span class="lineno"> 89 </span>        <span class="k">if</span> <span class="n">config_file_path</span><span class="p">:</span>
      <span class="lineno"> 90 </span>            <span class="k">try</span><span class="p">:</span>
      <span class="lineno"> 91 </span>                <span class="n">tree</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">)</span>
      <span class="lineno"> 92 </span>                <span class="k">if</span> <span class="n">iselement</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()):</span> <span class="c1"># valid xml element from file</span>
      <span class="lineno"> 93 </span>                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">tree</span>
      <span class="lineno"> 94 </span>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_file_path</span> <span class="o">=</span> <span class="n">config_file_path</span>
      <span class="lineno"> 95 </span>                <span class="k">else</span><span class="p">:</span> <span class="c1"># invalid xml, don&#39;t write on close</span>
      <span class="lineno"> 96 </span>                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ElementTree</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;socketchat&#39;</span><span class="p">))</span>
      <span class="lineno"> 97 </span>                    <span class="n">create_elem_with_subs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span> <span class="s1">&#39;request_server&#39;</span><span class="p">,</span>
      <span class="lineno"> 98 </span>                                          <span class="n">grandchild_elem_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="s2">&quot;12141&quot;</span><span class="p">})</span>
      <span class="lineno"> 99 </span>            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">ParseError</span><span class="p">):</span> <span class="c1"># parse(non-existent file)</span>
      <span class="lineno">100 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ElementTree</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;socketchat&#39;</span><span class="p">))</span>
      <span class="lineno">101 </span>                <span class="n">create_elem_with_subs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span> <span class="s1">&#39;request_server&#39;</span><span class="p">,</span>
      <span class="lineno">102 </span>                                      <span class="n">grandchild_elem_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="s2">&quot;12141&quot;</span><span class="p">})</span>
      <span class="lineno">103 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">config_file_path</span> <span class="o">=</span> <span class="n">config_file_path</span>
      <span class="lineno">104 </span>
      <span class="lineno">105 </span>            <span class="c1"># kill existing ChatWindow(s). No longer guaranteed reference to their connection info.</span>
      <span class="lineno">106 </span>            <span class="c1"># use set of widget names, do not destroy using name directly from iter.</span>
      <span class="lineno">107 </span>            <span class="k">for</span> <span class="n">iid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">]:</span>
      <span class="lineno">108 </span>                <span class="k">if</span> <span class="n">iid</span> <span class="o">!=</span> <span class="s1">&#39;chatmain&#39;</span> <span class="ow">and</span> <span class="n">iid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">)]:</span>
      <span class="lineno">109 </span>                    <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
      <span class="lineno">110 </span>            <span class="c1">#TODO: map() calls work in 2.7, not in 3</span>
      <span class="lineno">111 </span>            <span class="c1"># drop existing values in the tree if any</span>
      <span class="lineno">112 </span>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">get_children</span><span class="p">()]</span>
      <span class="lineno">113 </span>            <span class="c1">#map(self.tree.delete, self.tree.get_children())</span>
      <span class="lineno">114 </span>            <span class="c1"># load new data to tree</span>
      <span class="lineno">115 </span>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">populate_connection</span><span class="p">(</span><span class="n">conn_elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">conn_elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">)]</span>
      <span class="lineno">116 </span>            <span class="c1">#map(self.populate_connection, self.config.iter(&#39;connection&#39;))</span>
      <span class="lineno">117 </span>    <span class="c1"># END load_config()</span>
      <span class="lineno">118 </span>
      <span class="lineno">119 </span>    <span class="k">def</span> <span class="nf">populate_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn_elem</span><span class="p">):</span>
      <span class="lineno">120 </span>        <span class="sd">&quot;&quot;&quot;Add connections to ui tree. Add mapping of address to iid in lookup dict.&quot;&quot;&quot;</span>
      <span class="lineno">121 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="n">iid</span><span class="o">=</span><span class="n">conn_elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
      <span class="lineno">122 </span>                         <span class="n">text</span><span class="o">=</span><span class="n">conn_elem</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;displayname&#39;</span><span class="p">),</span> <span class="n">tags</span><span class="o">=</span><span class="s1">&#39;#entry&#39;</span><span class="p">)</span>
      <span class="lineno">123 </span>        <span class="c1"># bind the callback on every obj that has the #entry tag</span>
      <span class="lineno">124 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">tag_bind</span><span class="p">(</span><span class="s1">&#39;#entry&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&lt;TreeviewSelect&gt;&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_click_connection</span><span class="p">)</span>
      <span class="lineno">125 </span>    <span class="c1"># END populate_connection()</span>
      <span class="lineno">126 </span>
      <span class="lineno">127 </span>    <span class="k">def</span> <span class="nf">_click_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="lineno">128 </span>        <span class="sd">&quot;&quot;&quot;callback on click of row in tree.&quot;&quot;&quot;</span>
      <span class="lineno">129 </span>        <span class="n">iid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">focus</span><span class="p">()</span>
      <span class="lineno">130 </span>        <span class="k">if</span> <span class="n">iid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
      <span class="lineno">131 </span>            <span class="c1"># set focus to existing window</span>
      <span class="lineno">132 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>
      <span class="lineno">133 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span><span class="o">.</span><span class="n">focus_set</span><span class="p">()</span>
      <span class="lineno">134 </span>        <span class="k">else</span><span class="p">:</span>
      <span class="lineno">135 </span>            <span class="n">conn_elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//connection[@id=&#39;{}&#39;]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iid</span><span class="p">))</span>
      <span class="lineno">136 </span>            <span class="k">if</span> <span class="n">conn_elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="c1"># FutureWarning</span>
      <span class="lineno">137 </span>                <span class="n">displayname</span> <span class="o">=</span> <span class="n">conn_elem</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;displayname&#39;</span><span class="p">)</span>
      <span class="lineno">138 </span>                <span class="n">address</span> <span class="o">=</span> <span class="n">conn_elem</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>
      <span class="lineno">139 </span>                <span class="n">ChatWindow</span><span class="p">(</span><span class="n">iid</span><span class="p">,</span> <span class="n">displayname</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
      <span class="lineno">140 </span>    <span class="c1"># END _click_connection()</span>
      <span class="lineno">141 </span>
      <span class="lineno">142 </span>    <span class="k">def</span> <span class="nf">_poll_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="lineno">143 </span>        <span class="sd">&quot;&quot;&quot;Poll a queue.Queue() until returns True. Pass message from queue to</span>
      <span class="lineno">144 </span><span class="sd">        ChatWindow based on addr.</span>
      <span class="lineno">145 </span>
      <span class="lineno">146 </span><span class="sd">        First, try to match address to iid from existing connection in config xml.</span>
      <span class="lineno">147 </span><span class="sd">        Then, see if ChatWindow with matching iid is already open.</span>
      <span class="lineno">148 </span><span class="sd">          If not, re-check config xml to fetch displayname.</span>
      <span class="lineno">149 </span><span class="sd">          If not, in config xml, spawn a new ChatWindow with new iid and hostname as displayname.&quot;&quot;&quot;</span>
      <span class="lineno">150 </span>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
      <span class="lineno">151 </span>            <span class="n">addr</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
      <span class="lineno">152 </span>            <span class="c1"># map address to iid in config xml</span>
      <span class="lineno">153 </span>            <span class="n">conn_elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//connection[address=&#39;{}&#39;]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
      <span class="lineno">154 </span>            <span class="k">if</span> <span class="n">conn_elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="lineno">155 </span>                <span class="n">iid</span> <span class="o">=</span> <span class="n">conn_elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
      <span class="lineno">156 </span>            <span class="k">else</span><span class="p">:</span>
      <span class="lineno">157 </span>                <span class="n">iid</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="lineno">158 </span>            <span class="c1"># need to spawn a new ChatWindow</span>
      <span class="lineno">159 </span>            <span class="k">if</span> <span class="n">iid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
      <span class="lineno">160 </span>                <span class="n">conn_elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//connection[@id=&#39;{}&#39;]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iid</span><span class="p">))</span>
      <span class="lineno">161 </span>                <span class="k">if</span> <span class="n">conn_elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="lineno">162 </span>                    <span class="n">displayname</span> <span class="o">=</span> <span class="n">conn_elem</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;displayname&#39;</span><span class="p">)</span>
      <span class="lineno">163 </span>                <span class="k">else</span><span class="p">:</span>
      <span class="lineno">164 </span>                    <span class="n">iid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
      <span class="lineno">165 </span>                    <span class="n">displayname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="lineno">166 </span>                <span class="n">ChatWindow</span><span class="p">(</span><span class="n">iid</span><span class="p">,</span> <span class="n">displayname</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
      <span class="lineno">167 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span><span class="o">.</span><span class="n">display_msg</span><span class="p">(</span><span class="s1">&#39;{}:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span><span class="o">.</span><span class="n">displayname</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;displayname&#39;</span><span class="p">,))</span>
      <span class="lineno">168 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span><span class="o">.</span><span class="n">display_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
      <span class="lineno">169 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">queue_listener_ptr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_listener_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_queue</span><span class="p">)</span>
      <span class="lineno">170 </span>    <span class="c1"># END _poll_queue()</span>
      <span class="lineno">171 </span>
      <span class="lineno">172 </span>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="lineno">173 </span>        <span class="sd">&quot;&quot;&quot;Callback on window close to write config to file.&quot;&quot;&quot;</span>
      <span class="lineno">174 </span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;config_file_path&#39;</span><span class="p">):</span>
      <span class="lineno">175 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file_path</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
      <span class="lineno">176 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
      <span class="lineno">177 </span>    <span class="c1"># END close()</span>
      <span class="lineno">178 </span><span class="c1"># END ChatMain</span>
    </pre></div>


    <p>The message window to chat with each individual connection.</p>
    <div class="highlight"><pre>
      <span class="lineno">181 </span><span class="k">class</span> <span class="nc">ChatWindow</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">Toplevel</span><span class="p">):</span>
      <span class="lineno">182 </span>    <span class="sd">&quot;&quot;&quot;Tkinter UI chat window with a single client.&quot;&quot;&quot;</span>
      <span class="lineno">183 </span>    <span class="n">timestamp_fmt</span> <span class="o">=</span> <span class="s1">&#39;%a, %b </span><span class="si">%d</span><span class="s1">, %Y %H:%M:%S&#39;</span>
      <span class="lineno">184 </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iid</span><span class="p">,</span> <span class="n">displayname</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="lineno">185 </span>        <span class="n">tk</span><span class="o">.</span><span class="n">Toplevel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">iid</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="lineno">186 </span>        <span class="c1"># ttk.Frame gets the default OS colors correct on MacOS</span>
      <span class="lineno">187 </span>        <span class="n">background_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="lineno">188 </span>        <span class="n">background_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="lineno">189 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">displayname</span> <span class="o">=</span> <span class="n">displayname</span>
      <span class="lineno">190 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
      <span class="lineno">191 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
      <span class="lineno">192 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayname</span><span class="p">)</span>
      <span class="lineno">193 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">resizable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># not resizeable</span>
      <span class="lineno">194 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">focus_force</span><span class="p">()</span>
      <span class="lineno">195 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">current_local_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
      <span class="lineno">196 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_fmt</span><span class="p">)</span>
      <span class="lineno">197 </span>        <span class="c1"># populate widgets</span>
      <span class="lineno">198 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="n">scrolledtext</span><span class="o">.</span><span class="n">ScrolledText</span><span class="p">(</span><span class="n">background_frame</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
      <span class="lineno">199 </span>                                                 <span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">WORD</span><span class="p">)</span>
      <span class="lineno">200 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">scrolledtext</span><span class="o">.</span><span class="n">ScrolledText</span><span class="p">(</span><span class="n">background_frame</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">WORD</span><span class="p">)</span>
      <span class="lineno">201 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">background_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Send&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
      <span class="lineno">202 </span>                               <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">send_and_display_msg</span><span class="p">)</span>
      <span class="lineno">203 </span>        <span class="c1"># text display tags - format how the text appears based on what generated the text</span>
      <span class="lineno">204 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">tag_config</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
      <span class="lineno">205 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">tag_config</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
      <span class="lineno">206 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">tag_config</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">CENTER</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
      <span class="lineno">207 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">tag_config</span><span class="p">(</span><span class="s1">&#39;displayname&#39;</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
      <span class="lineno">208 </span>        <span class="c1"># draw everything to screen</span>
      <span class="lineno">209 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="lineno">210 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="lineno">211 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>
      <span class="lineno">212 </span>        <span class="c1"># on startup, write the initial timestamp</span>
      <span class="lineno">213 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">display_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,))</span>
      <span class="lineno">214 </span>        <span class="c1"># bind Enter to Send button and ALT-Enter to place newline</span>
      <span class="lineno">215 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;Return&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_and_display_msg</span><span class="p">)</span>
      <span class="lineno">216 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;Alt-Return&gt;&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="s2">&quot;break&quot;</span><span class="p">)</span>
      <span class="lineno">217 </span>    <span class="c1"># END __init__()</span>
      <span class="lineno">218 </span>
      <span class="lineno">219 </span>    <span class="k">def</span> <span class="nf">_fetch_local_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="lineno">220 </span>        <span class="sd">&quot;&quot;&quot;If there are characters in the input window, send them to the display window.</span>
      <span class="lineno">221 </span><span class="sd">        Clear the input window. Return True if characters existed, else False.&quot;&quot;&quot;</span>
      <span class="lineno">222 </span>        <span class="n">ret</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="lineno">223 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">current_local_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="lineno">224 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_local_msg</span><span class="p">:</span>
      <span class="lineno">225 </span>            <span class="n">ret</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="lineno">226 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">display_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_local_msg</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,))</span>
      <span class="lineno">227 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>
      <span class="lineno">228 </span>        <span class="k">return</span> <span class="n">ret</span>
      <span class="lineno">229 </span>    <span class="c1"># END _fetch_local_msg()</span>
      <span class="lineno">230 </span>
      <span class="lineno">231 </span>    <span class="k">def</span> <span class="nf">display_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">text_tags</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="lineno">232 </span>        <span class="sd">&quot;&quot;&quot;Write msg to chat display window.</span>
      <span class="lineno">233 </span>
      <span class="lineno">234 </span><span class="sd">        text_tags should be a tuple:</span>
      <span class="lineno">235 </span><span class="sd">        ex: (&#39;local&#39;,)&quot;&quot;&quot;</span>
      <span class="lineno">236 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
      <span class="lineno">237 </span>        <span class="n">report_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_report_update_timestamp</span><span class="p">()</span>
      <span class="lineno">238 </span>        <span class="k">if</span> <span class="n">report_timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="lineno">239 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report_timestamp</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,))</span>
      <span class="lineno">240 </span>        <span class="k">if</span> <span class="n">text_tags</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="lineno">241 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
      <span class="lineno">242 </span>        <span class="k">else</span><span class="p">:</span>
      <span class="lineno">243 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">text_tags</span><span class="p">)</span>
      <span class="lineno">244 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
      <span class="lineno">245 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">yview</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>
      <span class="lineno">246 </span>    <span class="c1"># END display_msg()</span>
      <span class="lineno">247 </span>
      <span class="lineno">248 </span>    <span class="k">def</span> <span class="nf">send_and_display_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="lineno">249 </span>        <span class="sd">&quot;&quot;&quot;Displays the local message from the input window to the display window and</span>
      <span class="lineno">250 </span><span class="sd">        sends the message through a socket.&quot;&quot;&quot;</span>
      <span class="lineno">251 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_local_msg</span><span class="p">():</span>
      <span class="lineno">252 </span>            <span class="c1"># send to socket. If no server on other end, notify unavailable.</span>
      <span class="lineno">253 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">socket_send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_local_msg</span><span class="p">):</span>
      <span class="lineno">254 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">display_msg</span><span class="p">(</span><span class="s1">&#39;[user is unavailable]&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,))</span>
      <span class="lineno">255 </span>    <span class="c1"># END send_and_display_msg()</span>
      <span class="lineno">256 </span>
      <span class="lineno">257 </span>    <span class="k">def</span> <span class="nf">_report_update_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="lineno">258 </span>        <span class="sd">&quot;&quot;&quot;If current timestamp is older than 5 minutes, update to new time and</span>
      <span class="lineno">259 </span><span class="sd">        print to display window. Called from within display_msg().&quot;&quot;&quot;</span>
      <span class="lineno">260 </span>        <span class="n">ret</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="lineno">261 </span>        <span class="n">five_min_ago</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
      <span class="lineno">262 </span>        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_fmt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">five_min_ago</span><span class="p">:</span>
      <span class="lineno">263 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_fmt</span><span class="p">)</span>
      <span class="lineno">264 </span>            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span>
      <span class="lineno">265 </span>        <span class="k">return</span> <span class="n">ret</span>
      <span class="lineno">266 </span>    <span class="c1"># END _report_update_timestamp()</span>
      <span class="lineno">267 </span><span class="c1"># END ChatWindow</span>
    </pre></div>

    <p>A small GUI window to help add a new connection.</p>
    <div class="highlight"><pre>
      <span class="lineno">270 </span><span class="k">class</span> <span class="nc">NewConnection</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">Toplevel</span><span class="p">):</span>
      <span class="lineno">271 </span>    <span class="sd">&quot;&quot;&quot;Tkinter UI popup to add connection to xml.&quot;&quot;&quot;</span>
      <span class="lineno">272 </span>    <span class="n">listener_delay</span> <span class="o">=</span> <span class="mi">250</span> <span class="c1"># ms</span>
      <span class="lineno">273 </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_xml_tree</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="lineno">274 </span>        <span class="n">tk</span><span class="o">.</span><span class="n">Toplevel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;newconnection&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="lineno">275 </span>        <span class="n">background_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="lineno">276 </span>        <span class="n">background_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="lineno">277 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Add Connection&#39;</span><span class="p">)</span>
      <span class="lineno">278 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">resizable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># not resizeable</span>
      <span class="lineno">279 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config_xml_tree</span>
      <span class="lineno">280 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">()</span>
      <span class="lineno">281 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">displayname</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">()</span>
      <span class="lineno">282 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">()</span>
      <span class="lineno">283 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">focus_force</span><span class="p">()</span>
      <span class="lineno">284 </span>        <span class="c1"># create the UI objects</span>
      <span class="lineno">285 </span>        <span class="n">ttk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">background_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;hostname&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="lineno">286 </span>        <span class="n">ttk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">background_frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="lineno">287 </span>        <span class="n">ttk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">background_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;displayname&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="lineno">288 </span>        <span class="n">ttk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">background_frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">displayname</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="lineno">289 </span>        <span class="n">ttk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">background_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;address&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="lineno">290 </span>        <span class="n">ttk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">background_frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="lineno">291 </span>        <span class="n">button_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">background_frame</span><span class="p">)</span> <span class="c1"># additional frame to center buttons</span>
      <span class="lineno">292 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_button</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">button_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;address lookup&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
      <span class="lineno">293 </span>                                        <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="o">.</span><span class="n">get</span><span class="p">())))</span>
      <span class="lineno">294 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_button</span><span class="o">.</span><span class="n">state</span><span class="p">([</span><span class="s1">&#39;disabled&#39;</span><span class="p">])</span>
      <span class="lineno">295 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">add_button</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">button_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">)</span>
      <span class="lineno">296 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">add_button</span><span class="o">.</span><span class="n">state</span><span class="p">([</span><span class="s1">&#39;disabled&#39;</span><span class="p">])</span>
      <span class="lineno">297 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_button</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="lineno">298 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">add_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="lineno">299 </span>        <span class="n">button_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">columnspan</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="lineno">300 </span>        <span class="c1"># start the listener to check if fields are populated</span>
      <span class="lineno">301 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="p">()</span>
      <span class="lineno">302 </span>    <span class="c1"># END __init__()</span>
      <span class="lineno">303 </span>
      <span class="lineno">304 </span>    <span class="k">def</span> <span class="nf">_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="lineno">305 </span>        <span class="sd">&quot;&quot;&quot;check if the fields are populated before buttons are active.&quot;&quot;&quot;</span>
      <span class="lineno">306 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
      <span class="lineno">307 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">lookup_button</span><span class="o">.</span><span class="n">state</span><span class="p">([</span><span class="s1">&#39;!disabled&#39;</span><span class="p">])</span>
      <span class="lineno">308 </span>        <span class="k">else</span><span class="p">:</span>
      <span class="lineno">309 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">lookup_button</span><span class="o">.</span><span class="n">state</span><span class="p">([</span><span class="s1">&#39;disabled&#39;</span><span class="p">])</span>
      <span class="lineno">310 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayname</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
      <span class="lineno">311 </span>            <span class="c1"># bind Enter to Add button</span>
      <span class="lineno">312 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;Return&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">)</span>
      <span class="lineno">313 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">add_button</span><span class="o">.</span><span class="n">state</span><span class="p">([</span><span class="s1">&#39;!disabled&#39;</span><span class="p">])</span>
      <span class="lineno">314 </span>        <span class="k">else</span><span class="p">:</span>
      <span class="lineno">315 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="s1">&#39;&lt;Return&gt;&#39;</span><span class="p">)</span>
      <span class="lineno">316 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">add_button</span><span class="o">.</span><span class="n">state</span><span class="p">([</span><span class="s1">&#39;disabled&#39;</span><span class="p">])</span>
      <span class="lineno">317 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listener_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="p">)</span>
      <span class="lineno">318 </span>    <span class="c1"># END _listener()</span>
      <span class="lineno">319 </span>
      <span class="lineno">320 </span>    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="lineno">321 </span>        <span class="sd">&quot;&quot;&quot;callback for Add button.&quot;&quot;&quot;</span>
      <span class="lineno">322 </span>        <span class="c1"># parse the xml to see if a connection with same address already exists</span>
      <span class="lineno">323 </span>        <span class="n">conn_elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//connection[address=&#39;{}&#39;]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
      <span class="lineno">324 </span>        <span class="k">if</span> <span class="n">conn_elem</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c1">#TODO: notify user of existing connection</span>
      <span class="lineno">325 </span>            <span class="n">new_conn_elem</span> <span class="o">=</span> <span class="n">create_elem_with_subs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span> <span class="s1">&#39;connection&#39;</span><span class="p">,</span>
      <span class="lineno">326 </span>                                                  <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())},</span>
      <span class="lineno">327 </span>                                                  <span class="p">{</span><span class="s1">&#39;hostname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
      <span class="lineno">328 </span>                                                   <span class="s1">&#39;displayname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayname</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
      <span class="lineno">329 </span>                                                   <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">get</span><span class="p">()})</span>
      <span class="lineno">330 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s1">&#39;chatmain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">populate_connection</span><span class="p">(</span><span class="n">new_conn_elem</span><span class="p">)</span>
      <span class="lineno">331 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
      <span class="lineno">332 </span>    <span class="c1"># END _add()</span>
      <span class="lineno">333 </span><span class="c1"># END NewConnection</span>
    </pre></div>

    <p>For each incoming message on the server, spawn a new thread to handle() gathering the entire message and placing it on a queue.</p>
    <div class="highlight"><pre>
      <span class="lineno">336 </span><span class="k">class</span> <span class="nc">ChatRequestHandler</span><span class="p">(</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
      <span class="lineno">337 </span>    <span class="sd">&quot;&quot;&quot;Called from ThreadingTCPServer.</span>
      <span class="lineno">338 </span>
      <span class="lineno">339 </span><span class="sd">    Requires assigning a queue.Queue() to self.queue after instantiation.&quot;&quot;&quot;</span>
      <span class="lineno">340 </span>    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="lineno">341 </span>        <span class="sd">&quot;&quot;&quot;Receive a message from a socket connection and put tuple(addr, message) on a queue.&quot;&quot;&quot;</span>
      <span class="lineno">342 </span>        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
      <span class="lineno">343 </span>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="lineno">344 </span>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
      <span class="lineno">345 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
      <span class="lineno">346 </span>                <span class="k">break</span>
      <span class="lineno">347 </span>            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="n">data</span>
      <span class="lineno">348 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
      <span class="lineno">349 </span>    <span class="c1"># END handle()</span>
      <span class="lineno">350 </span><span class="c1"># END ChatRequestHandler</span>
</pre></div>

    <p>Common functions used to send the message from each chat window and create a new xml element in the configuration that represents a connection.</p>
    <div class="highlight"><pre>
      <span class="lineno">353 </span><span class="k">def</span> <span class="nf">socket_send_msg</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="lineno">354 </span>    <span class="sd">&quot;&quot;&quot;Send a message through a socket to a host. If failed, return False.&quot;&quot;&quot;</span>
      <span class="lineno">355 </span>    <span class="n">ret</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># assume success</span>
      <span class="lineno">356 </span>    <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
      <span class="lineno">357 </span>        <span class="k">try</span><span class="p">:</span>
      <span class="lineno">358 </span>            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
      <span class="lineno">359 </span>            <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
      <span class="lineno">360 </span>            <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
      <span class="lineno">361 </span>            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="lineno">362 </span>        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
      <span class="lineno">363 </span>            <span class="n">ret</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="lineno">364 </span>    <span class="k">return</span> <span class="n">ret</span>
      <span class="lineno">365 </span><span class="c1"># END socket_send_msg()</span>
      <span class="lineno">366 </span>
      <span class="lineno">367 </span>
      <span class="lineno">368 </span><span class="k">def</span> <span class="nf">create_elem_with_subs</span><span class="p">(</span><span class="n">parent_elem</span><span class="p">,</span> <span class="n">child_tag</span><span class="p">,</span> <span class="n">attrib_dict</span><span class="o">=</span><span class="p">{},</span> <span class="n">grandchild_elem_dict</span><span class="o">=</span><span class="p">{}):</span>
      <span class="lineno">369 </span>    <span class="sd">&quot;&quot;&quot;Extends the functionality of Element or SubElement to also create additional sub elements</span>
      <span class="lineno">370 </span><span class="sd">    from a dictionary.&quot;&quot;&quot;</span>
      <span class="lineno">371 </span>    <span class="n">child_elem</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">parent_elem</span><span class="p">,</span> <span class="n">child_tag</span><span class="p">,</span> <span class="n">attrib_dict</span><span class="p">)</span>
      <span class="lineno">372 </span>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">grandchild_elem_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="lineno">373 </span>        <span class="n">grandchild_elem</span> <span class="o">=</span> <span class="n">SubElement</span><span class="p">(</span><span class="n">child_elem</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
      <span class="lineno">374 </span>        <span class="n">grandchild_elem</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">v</span>
      <span class="lineno">375 </span>    <span class="k">return</span> <span class="n">child_elem</span>
      <span class="lineno">376 </span><span class="c1"># END create_elem_with_subs()</span>
      <span class="lineno">377 </span>
      <span class="lineno">378 </span>
      <span class="lineno">379 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
      <span class="lineno">380 </span>    <span class="n">ChatMain</span><span class="p">()</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</pre></div>


  </div>
{% endblock %}
